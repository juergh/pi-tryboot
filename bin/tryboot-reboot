#!/bin/bash -eu
#
# Reboot into a tryboot entry
#

function usage()
{
	cat <<EOF
Usage: $(basename "${0}") [-h]

Reboot into a tryboot entry (TBE).

Optional arguments:
  -h, --help  Show this help text and exit.
EOF
}

while [ ${#} -ne 0 ] ; do
	case "${1}" in
		-h|--help)
			usage
			exit
			;;
		*)
			echo "Invalid argument: ${1}" >&2
			exit 2
			;;
	esac
	# shellcheck disable=SC2317
	shift
done


# shellcheck disable=SC1091
. /usr/lib/rpi-tryboot/lib.sh

tb_print_boot_menu

cat <<EOF

Press ENTER to boot the default TBE (*).
Enter the index number to boot the corresponding TBE.
Enter 'x' or 'q' to exit.

EOF

tbe=
while [ -z "${tbe}" ] ; do
	printf "Choice: "
	read -r idx
	case "${idx,,}" in
		x|q)
			exit
			;;
		"")
			tbe=$(tb_get_default_tbe)
			;;
		*)
			tbe=$(tb_get_tbe_from_index "${idx}")
			;;
	esac
done

echo
echo "-- Reboot into ${tbe}"

tb_boot_tbe "${tbe}"
