#!/bin/bash -eu
#
# Reboot into a tryboot entry
#

function out()
{
	local rc=${?}

	trap - EXIT INT TERM HUP

	if [ -n "${MENU}" ] ; then
		rm -f "${MENU}"
	fi

	if [ ${rc} -ne 0 ] ; then
		echo "Script failed" >&2
	fi
}

function usage()
{
	cat <<EOF
Usage: $(basename "${0}") [-h] [-s]

Reboot into a tryboot entry (TBE).

Optional arguments:
  -h, --help  Show this help text and exit.
  -s, --show  Show the boot menu and exit.
EOF
}

show=0

while [ ${#} -ne 0 ] ; do
	case "${1}" in
		-h|--help)
			usage
			exit
			;;
		-s|--show)
			show=1
			;;
		*)
			echo "Invalid argument: ${1}" >&2
			exit 2
			;;
	esac
	# shellcheck disable=SC2317
	shift
done

PKG_DIR=/usr/lib/rpi-tryboot

MENU=
trap out EXIT INT TERM HUP

# shellcheck disable=SC1091
. "${PKG_DIR}"/lib.sh

tb_print_boot_menu

if [ ${show} -eq 1 ] ; then
	exit
fi

echo

tbe=
while [ -z "${tbe}" ] ; do
	printf "Choice: "
	read -r idx
	if [ -z "${idx}" ] ; then
		tbe=$(tb_get_default_tbe)
	else
		tbe=$(tb_get_tbe_from_index "${idx}")
	fi
done

tb_boot_tbe "${tbe}"
